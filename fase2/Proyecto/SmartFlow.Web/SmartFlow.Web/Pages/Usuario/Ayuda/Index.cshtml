@page
@model SmartFlow.Web.Pages.Usuario.Ayuda.IndexModel
@{
    ViewData["Title"] = "Ayuda - Chat con Admin";
}
<h2 class="mb-3">💬 Soporte / Ayuda</h2>

<div class="border rounded p-3 mb-3" style="height: 420px; overflow-y:auto; background:#f8f9fa">
    <div id="chatMensajes" class="border rounded p-3 mb-3" style="height: 420px; overflow-y:auto; background:#f8f9fa">

    @if (Model.Mensajes.Any())
    {
        foreach (var m in Model.Mensajes)
        {
            <div class="mb-2">
                <small class="text-muted">@m.Fecha:g</small><br />
                <span class="badge @(m.EmisorRol == "Usuario" ? "bg-primary" : "bg-dark")">@m.EmisorRol</span>
                <span class="ms-2">@m.Texto</span>
            </div>
        }
    }
    else
    {
        <div class="text-muted">Sin mensajes aún. Escribe el primero 👇</div>
    }
</div>

<form method="post" class="d-flex gap-2">
    <input type="text" name="texto" class="form-control" placeholder="Escribe tu mensaje…" required />
    <button type="submit" class="btn btn-primary">Enviar</button>
</form>

@if (!string.IsNullOrEmpty(Model.MensajeSistema))
{
    <div class="alert alert-info mt-3">@Model.MensajeSistema</div>
}
@section Scripts {
        <partial name="_ValidationScriptsPartial" />
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const chatDiv = document.getElementById("chatMensajes");
                let ultimoMensaje = "";

                // 🔁 Actualización inteligente del chat
                async function refrescarChat() {
                    try {
                        const res = await fetch('/Usuario/Ayuda/Index?handler=MensajesParciales');
                        if (!res.ok) throw new Error("Error al obtener mensajes");
                        const html = await res.text();

                        // Verificar si hay cambios reales (evita redibujar si es igual)
                        if (html.trim() !== ultimoMensaje.trim()) {
                            const estabaAbajo = chatDiv.scrollTop + chatDiv.clientHeight >= chatDiv.scrollHeight - 50;
                            chatDiv.innerHTML = html;
                            if (estabaAbajo) chatDiv.scrollTop = chatDiv.scrollHeight;
                            ultimoMensaje = html;
                        }
                    } catch (err) {
                        console.warn("Error al actualizar chat:", err.message);
                    }
                }

                // ⏱️ Actualizar cada 3 segundos
                setInterval(refrescarChat, 3000);

                // ⬇️ Scroll automático inicial
                chatDiv.scrollTop = chatDiv.scrollHeight;
            });
        </script>
}
