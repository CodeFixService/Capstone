@page
@model SmartFlow.Web.Pages.Usuario.Calendario.IndexModel
@{
    ViewData["Title"] = "Calendario de Reservas";
}

<h2 class="text-center mb-4 fw-semibold">📅 Mi Calendario de Reservas</h2>

<div id="calendar" class="rounded-4 shadow-lg bg-white p-3"></div>

<!-- 🔹 Modal de Reserva RMX -->
<div class="modal fade" id="modalReserva" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div class="modal-header text-white"
                 style="background: linear-gradient(90deg, #007bff, #00b4d8);">
                <h5 class="modal-title fw-semibold">Nueva Reserva</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formReserva">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Fecha seleccionada</label>
                        <input id="fechaSeleccionada" class="form-control" readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Hora de inicio</label>
                        <select id="horaInicio" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Hora de término</label>
                        <select id="horaFin" class="form-select" disabled></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Servicio</label>
                        <select id="servicio" class="form-select" required></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Comentario</label>
                        <textarea id="comentario" class="form-control" rows="2"
                                  placeholder="Escribe un comentario opcional..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarReserva">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- 🔹 Modal de Mensajes RMX -->
<div class="modal fade" id="modalMensaje" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg border-0">
            <div id="mensajeHeader" class="modal-header text-white"
                 style="background: linear-gradient(90deg, #007bff, #00b4d8);">
                <h5 class="modal-title fw-semibold" id="mensajeTitulo">Mensaje</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center" id="mensajeCuerpo"></div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <!-- FULLCALENDAR + LOCALE ESPAÑOL -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/locales/es.global.min.js"></script>

    <script>

        let calendar;
        let fechaInicioSeleccionada = null;
                function cargarHoras() {

            const inicio = document.getElementById('horaInicio');
            const fin = document.getElementById('horaFin');

            inicio.innerHTML = "";
            fin.innerHTML = "";

            // Crear intervalos cada 30 minutos desde 09:00 hasta 19:30
            for (let h = 9; h <= 19; h++) {
                ["00", "30"].forEach(m => {

                    const hora = `${String(h).padStart(2, "0")}:${m}`;

                    // Crear opción solo para horaInicio
                    inicio.innerHTML += `<option value="${hora}">${hora}</option>`;
                });
            }

            // Cuando se elige horaInicio, calcular +30 minutos
            inicio.addEventListener("change", () => {

                const [hStr, mStr] = inicio.value.split(":");
                const h = parseInt(hStr);
                const m = parseInt(mStr);

                const fecha = new Date();
                fecha.setHours(h);
                fecha.setMinutes(m + 30);

                const hh = String(fecha.getHours()).padStart(2, "0");
                const mm = String(fecha.getMinutes()).padStart(2, "0");

                fin.innerHTML = `<option value="${hh}:${mm}">${hh}:${mm}</option>`;
            });
        }

        // 🔹 Necesaria para verificar disponibilidad
        function formatLocalDate(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${day}T${h}:${min}:00`;
        }

        document.addEventListener('DOMContentLoaded', function () {

            const calendarEl = document.getElementById('calendar');
            const modal = new bootstrap.Modal(document.getElementById('modalReserva'));
            const btnGuardar = document.getElementById('btnGuardarReserva');

            calendar = new FullCalendar.Calendar(calendarEl, {
               initialView: 'dayGridMonth',
                locale: 'es',
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    day: 'Día',
                    list: 'Lista'
                },
                dayHeaderFormat: { weekday: 'long' },
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },

                // 💥 BLOQUEAR DIAS PASADOS
                validRange: {
                    start: new Date().toISOString().split('T')[0]
                },

                // ⏰ HORARIO VISIBLE 09:00 - 20:00
                slotMinTime: "09:00:00",
                slotMaxTime: "20:00:00",

                selectable: true,

                events: '/Usuario/Calendario/Index?handler=Eventos',

                // 🟢 SELECCIONAR HORARIO PARA RESERVA
                        select: function(info) {

            fechaInicioSeleccionada = info.startStr;

            const fecha = new Date(info.start);

            document.getElementById('fechaSeleccionada').value =
                fecha.toLocaleDateString('es-CL');

            // Cargar lista de horas 09:00–19:30
            cargarHoras();

            // Forzar el cálculo de hora fin
            document.getElementById("horaInicio").dispatchEvent(new Event("change"));

            // Cargar servicios
            fetch('/Usuario/Calendario/Index?handler=Servicios')
                .then(res => res.json())
                .then(data => {
                    const select = document.getElementById('servicio');
                    select.innerHTML = "";
                    data.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.id;
                        opt.textContent = s.nombre;
                        select.appendChild(opt);
                    });

                    modal.show();
                });
        },


                eventClick: function (info) {

                    const ev = info.event;

                    let comentario = ev.extendedProps.comentarioAdmin ?? "Sin comentarios";

                    mostrarMensaje(
                        "Detalle de Reserva",
                        `
                        <b>Servicio:</b> ${ev.title}<br>
                        <b>Inicio:</b> ${ev.start.toLocaleString()}<br>
                        <b>Fin:</b> ${ev.end.toLocaleString()}<br>
                        <b>Estado:</b> ${ev.extendedProps.estado}<br>
                        <b>Comentario:</b> ${comentario}
                        `,
                        "info"
                    );
                }
            });

            calendar.render();


            // 🔥 SUMAR 30 MIN CUANDO USUARIO CAMBIE LA HORA MANUALMENTE
            document.getElementById('horaInicio').addEventListener('change', function () {

                const hora = this.value;
                if (!hora) return;

                const [h, m] = hora.split(':').map(Number);
                const fecha = new Date();
                fecha.setHours(h);
                fecha.setMinutes(m + 30);

                const hFin = String(fecha.getHours()).padStart(2, '0');
                const mFin = String(fecha.getMinutes()).padStart(2, '0');

                document.getElementById('horaFin').value = `${hFin}:${mFin}`;
            });


            // 🔹 GUARDAR RESERVA
            btnGuardar.addEventListener('click', function () {

                const servicioId = parseInt(document.getElementById('servicio').value);
                const comentario = document.getElementById('comentario').value;

                const horaInicio = document.getElementById('horaInicio').value;
                const horaFin = document.getElementById('horaFin').value;

                const baseDate = new Date(fechaInicioSeleccionada);
                const fechaBaseISO = baseDate.toISOString().split("T")[0];

                const fechaInicio = new Date(`${fechaBaseISO}T${horaInicio}:00`);
                const fechaFin = new Date(`${fechaBaseISO}T${horaFin}:00`);

                // VALIDACIONES
                if (!servicioId)
                    return mostrarMensaje("Falta servicio", "Debes seleccionar un servicio.", "warning");

                if (!horaInicio)
                    return mostrarMensaje("Falta hora de inicio", "Debes seleccionar un horario válido.", "warning");

                if (!horaFin)
                    return mostrarMensaje("Falta hora de término", "Debes seleccionar un horario válido.", "warning");


                // Primero verificar disponibilidad
                fetch('/Usuario/Calendario/Index?handler=VerificarDisponibilidad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fechaInicio: formatLocalDate(fechaInicio),
                        fechaFin: formatLocalDate(fechaFin)
                    })
                })
                    .then(r => r.json())
                    .then(v => {

                        if (!v.disponible) {
                            mostrarMensaje("⛔ Ocupado", "Este horario ya está reservado.", "warning");
                            return;
                        }

                        // Crear reserva
                        fetch('/Usuario/Calendario/Index?handler=Crear', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                servicioId: servicioId,
                                fechaInicio: formatLocalDate(fechaInicio),
                                fechaFin: formatLocalDate(fechaFin),
                                comentario: comentario
                            })
                        })
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) {
                                    modal.hide();
                                    mostrarMensaje("✔ Reserva creada", "La reserva fue registrada.", "success");
                                    calendar.refetchEvents();
                                }
                            });
                    });
            });


            // 🔄 AUTO-ACTUALIZAR EVENTOS
            setInterval(() => {
                try {
                    calendar.refetchEvents();
                } catch (e) {
                    console.log("Error refrescando", e);
                }
            }, 10000);


            // 🔹 Mostrar modal de mensaje
            function mostrarMensaje(titulo, cuerpo, tipo = "info") {

                const header = document.getElementById('mensajeHeader');
                const tituloElem = document.getElementById('mensajeTitulo');
                const cuerpoElem = document.getElementById('mensajeCuerpo');
                const modalMsg = new bootstrap.Modal(document.getElementById('modalMensaje'));

                let color = "#007bff";
                if (tipo === "success") color = "#198754";
                if (tipo === "error") color = "#dc3545";
                if (tipo === "warning") color = "#ffc107";

                header.style.background = `linear-gradient(90deg, ${color}, #00b4d8)`;
                tituloElem.textContent = titulo;
                cuerpoElem.innerHTML = `<p>${cuerpo}</p>`;

                modalMsg.show();
            }

        });

    </script>
}
