@page "{usuarioId:int}"
@model SmartFlow.Web.Pages.Admin.Ayuda.VerModel
@{
    ViewData["Title"] = "Chat con Usuario";
}
<h2 class="mb-3">💬 Chat con @Model.NombreUsuario</h2>

<div id="chatMensajesAdmin" class="border rounded p-3 mb-3" style="height: 420px; overflow-y:auto; background:#f8f9fa">
    @foreach (var m in Model.Mensajes)
    {
        <div class="mb-2">
            <small class="text-muted">@m.Fecha:g</small><br />
            <span class="badge @(m.EmisorRol == "Usuario" ? "bg-primary" : "bg-dark")">@m.EmisorRol</span>
            <span class="ms-2">@m.Texto</span>
        </div>
    }
</div>

<form method="post" class="d-flex gap-2">
    <input type="hidden" name="usuarioId" value="@Model.UsuarioId" />
    <input type="text" name="texto" class="form-control" placeholder="Escribe tu respuesta…" required />
    <button type="submit" class="btn btn-primary">Enviar</button>
</form>

@if (!string.IsNullOrEmpty(Model.MensajeSistema))
{
    <div class="alert alert-info mt-3">@Model.MensajeSistema</div>
}
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chatDiv = document.getElementById("chatMensajesAdmin");
            const usuarioId = "@Model.UsuarioId";

            // 🔹 Función para refrescar los mensajes del chat admin
            async function refrescarChatAdmin() {
                try {
        const response = await fetch(`/Admin/Ayuda/Ver/${usuarioId}?handler=MensajesParciales`);
                            if (!response.ok) return;

                    const html = await response.text();
                    chatDiv.innerHTML = html;
                    chatDiv.scrollTop = chatDiv.scrollHeight; // mantener scroll abajo
                } catch (error) {
                    console.error("Error al refrescar el chat del admin:", error);
                }
            }

            // 🔹 Primera carga
            refrescarChatAdmin();

            // 🔁 Refrescar cada 5 segundos
            setInterval(refrescarChatAdmin, 5000);

            // 🔹 Auto scroll cuando se envía un nuevo mensaje
            const form = document.querySelector("form");
            form.addEventListener("submit", function () {
                setTimeout(() => {
                    refrescarChatAdmin();
                    chatDiv.scrollTop = chatDiv.scrollHeight;
                }, 1000);
            });
        });
    </script>
}
